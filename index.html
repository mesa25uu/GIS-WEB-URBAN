<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Urban Map - Oxnehaga</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">

<style>
html, body {
  height:100%;
  width:100%;
  margin:0;
  padding:0;
  display:flex;
  font-family:'Segoe UI', sans-serif;
}

#sidePanel {
  width:280px;
  background:#1f2a38;
  color:white;
  padding:20px;
  overflow-y:auto;
}

#viewDiv {
  flex:1;
  height:100vh;
  position:relative;
}

.layer-item {
  margin-bottom:8px;
  display:flex;
  align-items:center;
  background:rgba(255,255,255,0.1);
  padding:8px;
  border-radius:4px;
}

.layer-item input { margin-right:10px; }

.dropdown { margin-bottom:10px; }

.dropdown-header {
  cursor:pointer;
  font-weight:bold;
  padding:8px;
  background:rgba(255,255,255,0.15);
  border-radius:4px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.dropdown-arrow { transition:0.3s; }

.dropdown-content {
  display:none;
  margin-top:5px;
  padding-left:10px;
}

.popup-btn {
  width:100%;
  padding:8px;
  background:#4A90E2;
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin-top:10px;
}
</style>
</head>

<body>

<div id="sidePanel">
  <h2 style="color:#4A90E2;margin:0;">GIS Web Urban</h2>
  <hr style="opacity:0.2;margin:15px 0;">
  <div id="controls"></div>
</div>

<div id="viewDiv"></div>

<script src="https://js.arcgis.com/4.29/"></script>

<script>
require([
  "esri/Map",
  "esri/views/SceneView",
  "esri/layers/GeoJSONLayer",
  "esri/widgets/Home"
], function(Map, SceneView, GeoJSONLayer, Home) {

const map = new Map({
  basemap:"topo-vector",
  ground:"world-elevation"
});

const view = new SceneView({
  container:"viewDiv",
  map:map,
  camera:{
    position:{ longitude:14.2622409, latitude:57.7781582, z:5000 },
    tilt:45
  }
});

view.ui.add(new Home({ view:view }), "top-left");


// ---------------- RENDERERS ----------------

const vardcentralRenderer = {
  type:"simple",
  symbol:{
    type:"simple-fill",
    color:[0,200,0,0.35],
    outline:{ color:[0,150,0], width:2 }
  }
};


// ---------------- MAIN BUILDING WITH RED ONE ----------------

const mainByggnad = new GeoJSONLayer({
  url:"Main_byggnad.geojson",
  elevationInfo:{ mode:"on-the-ground" },
  renderer:{
    type:"unique-value",
    field:"objektidentitet",
    defaultSymbol:{
      type:"polygon-3d",
      symbolLayers:[{
        type:"extrude",
        size:2,
        material:{ color:"#d9d9d9" },
        edges:{ type:"solid", color:"#888", size:0.6 }
      }]
    },
    uniqueValueInfos:[{
      value:"86068c15-afde-4284-90fc-ad8735b25416",
      symbol:{
        type:"polygon-3d",
        symbolLayers:[{
          type:"extrude",
          size:2,
          material:{ color:"#ff0000" },
          edges:{ type:"solid", color:"#888", size:0.6 }
        }]
      }
    }]
  },
  outFields:["*"]
});


// ---------------- OTHER LAYERS ----------------

const vardcentralWalking = new GeoJSONLayer({
  url:"Vardcentral_walking_distance.geojson",
  renderer:vardcentralRenderer,
  outFields:["*"]
});

map.addMany([
  mainByggnad,
  vardcentralWalking
]);


// ---------------- POPUP LOGIC ----------------

view.on("click", function(event){
  view.hitTest(event).then(function(response){

    const result = response.results.find(r =>
      r.graphic &&
      r.graphic.layer === mainByggnad
    );

    if(result){

      const attr = result.graphic.attributes;
      let content = "<b>Building Information</b><br><br>";

      for(let key in attr){
        content += "<b>"+key+"</b>: "+attr[key]+"<br>";
      }

      // Add button ONLY for that specific building
      if(attr.objektidentitet === "86068c15-afde-4284-90fc-ad8735b25416"){
        content += `
          <button class="popup-btn"
            onclick="window.location.href='Project4.html'">
            Open Project 4
          </button>
        `;
      }

      view.popup.open({
        title:"Main Building",
        content:content,
        location:event.mapPoint
      });

    } else {
      view.popup.close();
    }

  });
});

});
</script>

</body>
</html>
