<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Urban Map - Oxnehaga</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">

  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; display: flex; font-family: sans-serif; }
    
    #sidePanel {
      width: 280px;
      background-color: #1f2a38;
      color: white;
      padding: 20px;
      z-index: 5;
      overflow-y: auto;
    }

    #viewDiv { flex: 1; height: 100vh; position: relative; }

    /* Toggle Styles */
    .layer-item {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 5px;
    }
    .layer-item input { margin-right: 12px; transform: scale(1.2); cursor: pointer; }
    
    #infoPanel {
      position: absolute; top: 20px; right: 20px; width: 240px;
      background: white; padding: 15px; border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10; font-size: 13px;
    }
    hr { border: 0; border-top: 1px solid #444; margin: 15px 0; }
  </style>
</head>

<body>

  <div id="sidePanel">
    <h2>Urban Layers</h2>
    <hr>
    <div id="controls">
      </div>
  </div>

  <div id="viewDiv">
    <div id="infoPanel">
      <strong>Feature Info</strong>
      <div id="infoContent">Click a feature...</div>
    </div>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>

  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/GeoJSONLayer"
    ], function(Map, SceneView, GeoJSONLayer) {

      const map = new Map({
        basemap: "topo-vector",
        ground: "world-elevation"
      });

      const view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: { position: [14.2626, 57.7766, 2000], tilt: 45 }
      });

      // --- 1. RENDERERS ---
      
      // 3D Extrusion for Buildings
      const buildingRenderer = {
        type: "simple",
        symbol: {
          type: "polygon-3d",
          symbolLayers: [{
            type: "extrude",
            size: 12,
            material: { color: "#4A90E2" },
            edges: { type: "solid", color: "white", size: 1 }
          }]
        }
      };

      // Outline only for the Area (No fill)
      const areaRenderer = {
        type: "simple",
        symbol: {
          type: "simple-fill", 
          color: [0, 0, 0, 0], // Transparent fill
          outline: { color: "#ffcc00", width: 2 }
        }
      };

      // --- 2. LAYER CREATION ---

      const mainBuilding = new GeoJSONLayer({ url: "Main_byggnad.geojson", renderer: buildingRenderer, title: "Main Buildings" });
      const areaBoundary = new GeoJSONLayer({ url: "Oxnehaga-Area.geojson", renderer: areaRenderer, title: "Area Contour" });
      
      // Grouping layers for the single toggle
      const schoolLayer = new GeoJSONLayer({ url: "Oxnehaga_school.geojson", renderer: buildingRenderer });
      const routeLayer = new GeoJSONLayer({ url: "Oxnehaga_school_route.geojson" });
      const stationLayer = new GeoJSONLayer({ url: "Huskvarna_train_station.geojson" });

      map.addMany([areaBoundary, mainBuilding, schoolLayer, routeLayer, stationLayer]);

      // --- 3. TOGGLE LOGIC ---

      const controls = document.getElementById("controls");

      // Function to create a standard toggle
      function createToggle(name, layers) {
        const div = document.createElement("div");
        div.className = "layer-item";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        
        checkbox.onclick = (e) => {
          layers.forEach(lyr => lyr.visible = e.target.checked);
        };

        const label = document.createElement("label");
        label.innerHTML = name;

        div.appendChild(checkbox);
        div.appendChild(label);
        controls.appendChild(div);
      }

      // Create individual toggles
      createToggle("Area Contour", [areaBoundary]);
      createToggle("Main Buildings", [mainBuilding]);

      // Create the GROUPED toggle for Schools and Train Station
      createToggle("School & Train Info", [schoolLayer, routeLayer, stationLayer]);

      // Click event for info panel
      view.on("click", (event) => {
        view.hitTest(event).then((response) => {
          if (response.results.length > 0 && response.results[0].graphic) {
            const attr = response.results[0].graphic.attributes;
            let content = "<ul>";
            for (let key in attr) { content += `<li><b>${key}:</b> ${attr[key]}</li>`; }
            document.getElementById("infoContent").innerHTML = content + "</ul>";
          }
        });
      });
    });
  </script>
</body>
</html>
