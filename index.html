require([
      "esri/Map", 
      "esri/views/SceneView", 
      "esri/layers/GeoJSONLayer",
      "esri/widgets/Home"
    ], function(Map, SceneView, GeoJSONLayer, Home) {

      const map = new Map({ 
        basemap: "topo-vector", 
        ground: "world-elevation" 
      });

      const view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: {
          position: {
            longitude: 14.262240914858294,
            latitude: 57.77815821622224,
            z: 5000 
          },
          tilt: 0,
          heading: 0
        },
        popupEnabled: false
      });

      const homeBtn = new Home({ view: view });
      view.ui.add(homeBtn, "top-left");

      // Renderers
      const buildingRenderer = {
        type: "simple",
        symbol: {
          type: "polygon-3d",
          symbolLayers: [{ 
            type: "extrude", 
            size: 12, 
            material: { color: "#4A90E2" }, 
            edges: { type: "solid", color: "white", size: 1 } 
          }]
        }
      };

      const areaRenderer = {
        type: "simple",
        symbol: { 
          type: "simple-fill", 
          color: [0, 0, 0, 0], 
          outline: { color: "#FFD700", width: 3 } 
        }
      };

      // --- LAYERS WITH outFields: ["*"] ADDED ---
      // This ensures every attribute is downloaded and available for the click event
      const areaBoundary = new GeoJSONLayer({ 
        url: "Oxnehaga-Area.geojson", 
        renderer: areaRenderer, 
        title: "Area Contour",
        outFields: ["*"] // ⬅️ This grabs all data columns
      });

      const mainBuilding = new GeoJSONLayer({ 
        url: "Main_byggnad.geojson", 
        renderer: buildingRenderer, 
        title: "Main Buildings",
        outFields: ["*"] 
      });

      const schoolLayer = new GeoJSONLayer({ 
        url: "Oxnehaga_school.geojson", 
        renderer: buildingRenderer,
        outFields: ["*"]
      });

      const routeLayer = new GeoJSONLayer({ 
        url: "Oxnehaga_school_route.geojson",
        outFields: ["*"]
      });

      const stationLayer = new GeoJSONLayer({ 
        url: "Huskvarna_train_station.geojson",
        outFields: ["*"]
      });

      map.addMany([areaBoundary, mainBuilding, schoolLayer, routeLayer, stationLayer]);

      // Side Toggles
      const controls = document.getElementById("controls");
      function addLayerToggle(label, layersGroup) {
        const item = document.createElement("div");
        item.className = "layer-item";
        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.checked = true;
        cb.onchange = (e) => { layersGroup.forEach(l => l.visible = e.target.checked); };
        item.appendChild(cb);
        const text = document.createElement("span");
        text.innerText = label;
        item.appendChild(text);
        controls.appendChild(item);
      }

      addLayerToggle("Area Boundary", [areaBoundary]);
      addLayerToggle("Main Buildings", [mainBuilding]);
      addLayerToggle("Schools & Transport", [schoolLayer, routeLayer, stationLayer]);

      // Info Panel Logic
      view.on("click", (event) => {
        // The hitTest checks which building/line you actually clicked
        view.hitTest(event).then((response) => {
          const results = response.results.filter(r => r.graphic);
          
          if (results.length > 0) {
            const graphic = results[0].graphic;
            const attr = graphic.attributes;

            // We build the table by looking at every piece of data in 'attr'
            let tableHTML = "<table>";
            for (let key in attr) {
              // We skip attributes that are empty or internal IDs like 'OBJECTID' if you want
              if (attr[key] !== null && attr[key] !== undefined && attr[key] !== "") {
                tableHTML += `<tr><td class="attr-key">${key}</td><td>${attr[key]}</td></tr>`;
              }
            }
            tableHTML += "</table>";
            
            document.getElementById("infoContent").innerHTML = tableHTML;
          } else {
            document.getElementById("infoContent").innerHTML = "No feature selected.";
          }
        });
      });
    });
