<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Urban Map - Oxnehaga</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">

<style>
html, body { height:100%; width:100%; margin:0; padding:0; display:flex; font-family:'Segoe UI', sans-serif; }
#sidePanel { width:280px; background:#1f2a38; color:white; padding:20px; overflow-y:auto; }
#viewDiv { flex:1; height:100vh; position:relative; }
#infoPanel { position:absolute; top:20px; right:20px; width:320px; max-height:70vh; overflow-y:auto; background:white; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.4); border:1px solid #ccc; }
.info-header { background:#4A90E2; color:white; padding:10px 15px; border-radius:8px 8px 0 0; font-weight:bold; }
#infoContent { padding:15px; font-size:13px; }
.layer-item { margin-bottom:8px; display:flex; align-items:center; background:rgba(255,255,255,0.1); padding:8px; border-radius:4px; }
.layer-item input { margin-right:10px; }
.dropdown { margin-bottom:10px; }
.dropdown-header { cursor:pointer; font-weight:bold; padding:8px; background:rgba(255,255,255,0.15); border-radius:4px; display:flex; justify-content:space-between; align-items:center; }
.dropdown-arrow { transition:0.3s; }
.dropdown-content { display:none; margin-top:5px; padding-left:10px; }
table { width:100%; border-collapse:collapse; }
td { padding:6px 4px; border-bottom:1px solid #eee; vertical-align:top; }
.attr-key { font-weight:bold; color:#666; width:45%; font-size:11px; text-transform:uppercase; }

/* Popup button */
.btn-inline {
  display:inline-block; padding:8px 12px; margin-bottom:10px;
  border-radius:4px; background:#4A90E2; color:#fff; text-decoration:none;
  font-size:12px; font-weight:600;
}
.btn-inline:hover { background:#357ac8; }
</style>
</head>

<body>
<div id="sidePanel">
  <h2 style="color:#4A90E2;margin:0;">GIS Web Urban</h2>
  <hr style="opacity:0.2;margin:15px 0;">
  <!-- BUTTON REMOVED AS REQUESTED -->
  <div id="controls"></div>
</div>

<div id="viewDiv">
  <div id="infoPanel">
    <div class="info-header">Feature Details</div>
    <div id="infoContent">Click on a feature to see all attributes.</div>
  </div>
</div>

<script src="https://js.arcgis.com/4.29/"></script>
<script>
require([
  "esri/Map", "esri/views/SceneView", "esri/layers/GeoJSONLayer", "esri/widgets/Home"
], function(Map, SceneView, GeoJSONLayer, Home) {

  const map = new Map({ basemap: "topo-vector", ground: "world-elevation" });
  const view = new SceneView({
    container: "viewDiv",
    map: map,
    popupEnabled: true,
    camera: {
      position: {
        longitude: 14.262351248852866,
        latitude: 57.77795564556115,
        z: 3500
      },
      tilt: 45
    }
  });

  view.ui.add(new Home({ view: view }), "top-left");

  // ---------------- RENDERERS ----------------
  const busRenderer = {
    type: "simple",
    symbol: {
      type: "simple-marker",
      color: "#FFD21E",
      size: 11,
      style: "circle",
      outline: { color: "#1b1b1b", width: 1.5 }
    }
  };

  const schoolIconRenderer = {
    type: "simple",
    symbol: {
      type: "picture-marker",
      url: "https://static.arcgis.com/images/Symbols/Education/School.png",
      width: "22px", height: "22px"
    }
  };

  const areaRenderer = { type:"simple", symbol:{ type:"simple-fill", color:[0,0,0,0], outline:{ color:"#00aa00", width:3 } } };
  const trainLineRenderer = { type:"simple", symbol:{ type:"simple-line", color:"#ff0000", width:4, style:"dash" } };
  const schoolRouteRenderer = { type:"simple", symbol:{ type:"simple-line", color:"#8A2BE2", width:5 } };
  const vardcentralRenderer = { type:"simple", symbol:{ type:"simple-fill", color:[0,200,0,0.35], outline:{ color:[0,150,0], width:2 } } };
  const distanceRenderer = { type:"simple", symbol:{ type:"simple-fill", color:[255,165,0,0.3], outline:{ color:[255,140,0], width:2 } } };

  // ---------------- LAYERS ----------------
  const mainByggnad = new GeoJSONLayer({
    url: "Main_byggnad.geojson",
    elevationInfo: { mode: "on-the-ground" },
    renderer: {
      type: "unique-value", field: "objektidentitet",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [{
          type: "extrude", size: 2,
          material: { color: "#d9d9d9" },
          edges: { type: "solid", color: "#888", size: 0.6 }
        }]
      },
      uniqueValueInfos: [{
        value: "86068c15-afde-4284-90fc-ad8735b25416",
        symbol: {
          type: "polygon-3d",
          symbolLayers: [{
            type: "extrude", size: 2,
            material: { color: "#ff0000" },
            edges: { type: "solid", color: "#888", size: 0.6 }
          }]
        }
      }]
    },
    outFields: ["*"]
  });

  const areaLayer = new GeoJSONLayer({ url: "Oxnehaga-Area.geojson", renderer: areaRenderer, outFields: ["*"] });
  const schoolLayer = new GeoJSONLayer({ url: "Oxnehaga_school.geojson", renderer: schoolIconRenderer, elevationInfo: { mode: "on-the-ground" }, outFields: ["*"] });
  const schoolRoute = new GeoJSONLayer({ url: "Oxnehaga_school_route.geojson", renderer: schoolRouteRenderer, outFields: ["*"] });
  const trainStation = new GeoJSONLayer({ url: "Huskvarna_train_station.geojson", outFields: ["*"] });
  const trainLines = new GeoJSONLayer({ url: "train.geojson", renderer: trainLineRenderer, outFields: ["*"] });
  const distansLayer = new GeoJSONLayer({ url: "Distans_from_centrum.geojson", visible: false, renderer: distanceRenderer, outFields: ["*"] });
  const vardcentralWalking = new GeoJSONLayer({ url: "Vardcentral_walking_distance.geojson", renderer: vardcentralRenderer, outFields: ["*"] });
  const kindergartenLayer = new GeoJSONLayer({ url: "Kinder_Garden.geojson", outFields: ["*"] });
  const schoolServiceLayer = new GeoJSONLayer({ url: "Oxnehaga_school.geojson", renderer: schoolIconRenderer, elevationInfo: { mode: "on-the-ground" }, outFields: ["*"] });
  const busStopLayer = new GeoJSONLayer({
    url: "Bus_stop.geojson",
    renderer: busRenderer,
    elevationInfo: { mode: "on-the-ground" },
    outFields: ["*"]
  });

  map.addMany([
    areaLayer, mainByggnad, schoolLayer, schoolRoute,
    trainStation, trainLines, distansLayer, vardcentralWalking,
    kindergartenLayer, schoolServiceLayer, busStopLayer
  ]);

  // ---------------- POPUP BUTTON ----------------
  const TARGET_OID = "86068c15-afde-4284-90fc-ad8735b25416";

  mainByggnad.popupTemplate = {
    title: "Building details",
    outFields: ["*"],
    content: (e) => {
      const g = e.graphic;
      const attr = g.attributes || {};
      const isTarget = (attr.objektidentitet === TARGET_OID);

      let html = "";
      if (isTarget) {
        html += '<a href="Project4.html" target="_blank" rel="noopener noreferrer" class="btn-inline">Open Project 4</a>';
      }

      html += "<table>";
      for (const k in attr) {
        html += `<tr><td class="attr-key">${k}</td><td>${attr[k]}</td></tr>`;
      }
      html += "</table>";
      return html;
    }
  };

  // ---------------- HIT TEST ----------------
  view.on("click", (event) => {
    view.hitTest(event).then((response) => {
      const results = response.results.filter(r => r.graphic && r.graphic.layer && r.graphic.layer.type==="geojson");
      if(results.length > 0){
        let attr = results[0].graphic.attributes;
        let tableHTML = "<table>";
        for(let key in attr){ tableHTML += `<tr><td class="attr-key">${key}</td><td>${attr[key]}</td></tr>`; }
        tableHTML += "</table>";
        document.getElementById("infoContent").innerHTML = tableHTML;
      } else {
        document.getElementById("infoContent").innerHTML = "No feature selected.";
      }
    });
  });

});
</script>
</body>
</html>
